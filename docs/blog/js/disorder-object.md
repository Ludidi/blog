# æ— åºå¯¹è±¡

[[toc]]

å¸¸è§„æƒ…å†µä¸‹ï¼Œä½¿ç”¨å¯¹è±¡æ—¶ä¼šè·å–æŸä¸ªå¯¹è±¡æŒ‡å®šé”®ä¸‹çš„å€¼ï¼Œä½†å½“éå†æˆ–è€…æ‰“å°è¾“å‡ºçš„æ—¶å€™ä¼šå‘ç°å¯¹è±¡æ˜¯æ— åºçš„ï¼Œå¹¶ä¸æ˜¯æŒ‰ç…§æ·»åŠ çš„é¡ºåºè¾“å‡ºï¼Œä¸ºä»€ä¹ˆä¼šå‡ºç°è¿™ç§é—®é¢˜ï¼Œæœ¬ç¯‡åˆ™åˆ©ç”¨`Object.keys()`æ–¹æ³•æ·±å…¥åˆ° ECMA è§„èŒƒä¸­å»äº†è§£ã€‚

## ç¤ºä¾‹

å…ˆæ¥çœ‹ä¸€ä¸‹ç¤ºä¾‹ï¼š

```js
const obj = { a: 1, c: 2, b: 3, 2: 4, 1: 5 };
console.log(Object.keys(obj)); // ["1", "2", "a", "c", "b"]
```

ä¼¼ä¹ js å¼•æ“åšäº†ä¸€äº›é»˜è®¤å¤„ç†ï¼š

1. æå–äº† 2 å’Œ 1ï¼Œåšäº†å‡åºæ’åº
2. å‰©ä¸‹çš„ aã€cã€b æŒ‰ç…§å…ˆåé¡ºåºæ’åº

## è§„èŒƒ

[æŸ¥çœ‹è§„èŒƒ](https://tc39.es/ecma262/)ï¼Œæœç´¢`Object.keys()`è·å–å…¶è¯¦ç»†å®šä¹‰

![1-1](/images/js/disorder-object-1-1.png)

## è§£è¯» Object.keys()

å½“ä½¿ç”¨å‚æ•° O æ—¶è°ƒç”¨ keys å‡½æ•°ï¼Œåˆ™ä¼šæœ‰ä»¥ä¸‹ä¸‰ä¸ªæ­¥éª¤ï¼š

### 1. Let obj be ? ToObject(O).

ç›¸å½“äº`let obj = ToObject(O)`ã€‚å®šä¹‰ä¸€ä¸ª obj éå†ï¼Œæ‰§è¡Œ ToObject(O)è¿™ä¸ªå‡½æ•°ï¼Œè€Œ`O`å°±æ˜¯ä¼ å…¥åˆ°`Object.keys()`é‡Œé¢çš„è¿™ä¸ªå‚æ•°ã€‚

> ç‚¹å‡» ToObject å¯ä»¥çœ‹åˆ°å¦‚ä¸‹å®šä¹‰:

![1-2](/images/js/disorder-object-1-2.png)

ç”±æ­¤å¯è§ï¼Œå‚æ•°ç±»å‹å¦‚æœæ˜¯ undefined æˆ–è€… null æ—¶ï¼Œä¼šå¯¼è‡´ç±»å‹é”™è¯¯ï¼Œå¯ä»¥ç®€å•æµ‹è¯•ä¸€ä¸‹:

```js
console.log(Object.keys(undefined));
// Uncaught TypeError: Cannot convert undefined or null to object
```

æœç„¶å¦‚æ­¤ï¼Œç„¶åçœ‹æœ€åä¸€è¡Œï¼Œå¦‚æœé‡Œé¢ä¼ å…¥ä¸€ä¸ªå¯¹è±¡ï¼Œåˆ™å°±ä¼šè¿”å›ä¼ å…¥çš„è¿™ä¸ªå‚æ•°

### 2. Let nameList be ? EnumerableOwnPropertyNames(obj, key).

ç„¶ååˆå®šä¹‰ä¸€ä¸ª nameListï¼Œå…¶å€¼ä¸º`EnumerableOwnPropertyNames(obj, key)`è¿”å›çš„ç»“æœã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„ç¬¬ä¸€ä¸ªå‚æ•°`obj`æ˜¯ç”±ç¬¬ä¸€æ­¥`ToObject`è¿”å›çš„`obj`ï¼Œç¬¬äºŒä¸ªå‚æ•°`key`å°±æ˜¯ä¸ªå­—é¢é‡ï¼Œå…¶å€¼å°±æ˜¯`key`ã€‚

æŸ¥çœ‹`EnumerableOwnPropertyNames`çš„å®šä¹‰ï¼Œä»å­—é¢ä¸Šå¯ä»¥è·çŸ¥ä»–æ˜¯å¯ä»¥å¾—åˆ°å¯æšä¸¾è‡ªèº«å±æ€§çš„é”®ï¼Œç„¶åæˆ‘ä»¬æ¥è¯¦ç»†ç‚¹è¿›å»çœ‹ä¸€ä¸‹ï¼š

![1-3](/images/js/disorder-object-1-3.png)

æŠ½è±¡æ“ä½œ`EnumerableOwnPropertyNames`æ¥å—å‚æ•°`O`(ä¼ å…¥çš„ Object)å’Œ`kind`(é”®ã€å€¼æˆ–è€…é”®å’Œå€¼)ï¼Œå®ƒåœ¨è¢«è°ƒç”¨æ—¶æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š

- æ–­è¨€ç±»å‹`O`æ˜¯`object`
- å®šä¹‰å˜é‡`ownKeys`æ˜¯`O.[[OwnPropertyKeys]]()`è¿”å›çš„ç»“æœ _ï¼ˆ`[[OwnPropertyKeys]]`ä¸º js çš„å†…éƒ¨æ–¹æ³•ï¼Œåªèƒ½ js å¼•æ“è°ƒç”¨ï¼Œä¸èƒ½ js è°ƒç”¨ï¼‰_
- åˆ›å»ºä¸€ä¸ª`properties`ä¸ºç©ºåˆ—è¡¨`empty list`
- éå†`ownKeys`åˆ—è¡¨ï¼Œå–å¾—æ¯ä¸€ä¸ª`key`:
  - å¦‚æœ`Type(key)`ä¸º`String`ï¼Œåˆ™ï¼š
    - å®šä¹‰å˜é‡`desc`ä¸º`O.[[GetOwnProperty]](key)`çš„è¿”å›å€¼ï¼Œdesc ä¸ºæè¿°å¯¹è±¡
    - å¦‚æœ`desc`ä¸æ˜¯`undefined`ï¼Œä¸”`desc`çš„`[[Enumerable]]`å¯æšä¸¾å€¼ä¸º`true`ï¼Œåˆ™ï¼š
      - å¦‚æœ`kind`æ˜¯`key`ï¼Œåˆ™æ·»åŠ `key`åˆ°`properties`
      - å¦åˆ™
        - å®šä¹‰`value`ä¸º`Get(O, key)`çš„å€¼
        - å¦‚æœ`kind`ä¸º`value`ï¼Œåˆ™æ·»åŠ `value`åˆ°`properties`
        - å¦åˆ™
          - æ–­è¨€`kind`æ˜¯`key + value`
          - å®šä¹‰`entry`ä¸º`CreateArrayFromList(<<key, value>>)`
          - æ·»åŠ `entry`åˆ°`properties`
- æœ€å`return properties`

ç”±äºå…¥å‚`kind`ç±»å‹ä¸º`key`ï¼Œåˆ™æ ¹æ®ä»¥ä¸Šé€»è¾‘å°†ç¬¦åˆæ¡ä»¶çš„`ownKeys`çš„å€¼æ·»åŠ åˆ°`properties`åˆ—è¡¨ä¸­ï¼Œæœ€ç»ˆå¾—åˆ°äº†`nameList`

### 3. Return CreateArrayFromList(nameList).

æœ€åä¸€æ­¥æ¯”è¾ƒç®€å•ï¼Œå°†`nameList`è½¬ä¸º`array`ï¼Œæœ€ç»ˆ`return array`å°±ç»“æŸäº†ã€‚å¯æ˜¯çœ‹åˆ°è¿™é‡Œå‘ç°ï¼Œå¥½åƒæ²¡æœ‰å¯¹ key åšæ’åºå¤„ç†ï¼Œåˆ°åº•æ˜¯å“ªä¸€æ­¥åšäº†ç‰¹æ®Šçš„å¤„ç†äº†ï¼Ÿå†å›è¿‡å¤´è¯¦ç»†çœ‹ä¸€ä¸‹ï¼Œå‘ç°ç¬¬äºŒæ­¥é‡Œé¢è·å–`ownKeys`æ—¶ï¼Œå¿½ç•¥äº†`[[OwnPropertyKeys]]`è¿™ä¸ªå†…ç½®æ–¹æ³•ï¼Œè®©æˆ‘ä»¬å†æ¥è¯¦ç»†çœ‹ä¸‹è¿™ä¸ªè§„èŒƒ

#### [[OwnPropertyKeys]]

![1-4](/images/js/disorder-object-1-4.png)

åœ¨è¿™ä¸ªæ–¹æ³•é‡Œé¢ï¼Œ`[[OwnPropertyKeys]]`æ˜¯ä¸å¸¦å‚æ•°çš„ï¼Œäºæ˜¯æ‰§è¡Œä¸‹é¢è¿™ä¸ªæ–¹æ³•`[[OrdinaryOwnPropertyKeys(O)]]`ï¼Œé‡Œé¢æ‰§è¡Œçš„è¿‡ç¨‹ï¼Œè®©æˆ‘ä»¬æ¥è¯¦ç»†è§£è¯»ä¸€ä¸‹ï¼š

- å®šä¹‰`keys`ä¸ºä¸€ä¸ªç©ºçš„`list`
- éå†å¯¹è±¡`O`å–å¾—æ¯ä¸€ä¸ªé”®`P`ï¼Œå¦‚æœ`P`ç¬¦åˆ`array index`å®šä¹‰çš„å±æ€§ï¼Œåˆ™è¿›è¡Œå‡åºæ’åºï¼Œæ‰§è¡Œ:
  - æŠŠ`P`æ·»åŠ åˆ°`keys`é‡Œé¢
- éå†å¯¹è±¡`O`å–å¾—æ¯ä¸€ä¸ªé”®`P`ï¼Œå¦‚æœ`P`çš„ç±»å‹`Type(P)`æ˜¯`String`å¹¶ä¸”`P`ä¸æ˜¯`array index`ï¼Œåˆ™æŒ‰ç…§å±æ€§åˆ›å»ºçš„æ—¶é—´çš„é¡ºåºå‡åºï¼Œæ‰§è¡Œï¼š
  - æŠŠ`P`æ·»åŠ åˆ°`keys`é‡Œé¢
- éå†å¯¹è±¡`O`å–å¾—æ¯ä¸€ä¸ªé”®`P`ï¼Œå¦‚æœ`p`çš„ç±»å‹`Type(P)`æ˜¯`Symbol`ï¼Œåˆ™æŒ‰ç…§å±æ€§åˆ›å»ºçš„æ—¶é—´çš„é¡ºåºå‡åºï¼Œæ‰§è¡Œï¼š
  - æŠŠ`P`æ·»åŠ åˆ°`keys`é‡Œé¢
- æœ€å`return keys`

åˆ°äº†è¿™ä¸€æ­¥ï¼Œæ‰¾åˆ°äº†é—®é¢˜çš„ç­”æ¡ˆï¼Œæ­£æ˜¯`[[OwnPropertyKeys]]`ä¸­å¯¹åŸå§‹å¯¹è±¡åšäº†åˆ†ç±»å’Œæ’åºï¼Œæ‰€ä»¥ä¸è®º`array index`åœ¨å¯¹è±¡é‡Œé¢å¦‚ä½•å»å®šä¹‰ï¼Œæœ€ç»ˆéƒ½ä¼šå¾—åˆ°ä»¥`array index`å‡åºåçš„å¯¹è±¡ï¼Œç„¶åå†å¯¹å…¶é”®çš„ç±»å‹è¿›è¡Œåˆ†ç±»`array index => string => Symbol`ã€‚

#### array index

è¿™é‡Œçš„`array index`å¹¶ä¸æ˜¯æˆ‘ä»¬æ‰€ç†è§£çš„æ•°ç»„ç´¢å¼•ï¼Œå…¶å®æ˜¯æ•´æ•°ç´¢å¼•ï¼Œçœ‹ä¸‹å®˜æ–¹çš„æè¿°:

> An array index is an integer index whose numeric value i is in the range +0ğ”½ â‰¤ i < ğ”½(2<sup>32</sup> - 1).

è¿™ä¸ª`i`æ˜¯æœ‰èŒƒå›´çš„`0 <= i <= 2**32 - 1`ï¼Œæˆ‘ä»¬å¯ä»¥æ¥æµ‹è¯•ä¸€ä¸‹ï¼š

```js
const obj = { a: 1, c: 2, b: 3, 2: 4, 1: 5 };
const s = Symbol('s');
obj[s] = 6;
obj[-1] = 7;
obj[2 ** 32 - 1] = 8;
obj[2 ** 32 - 2] = 9;

console.log(Object.keys(obj)); // ["1", "2", "4294967294", "a", "c", "b", "-1", "4294967295"]
```

æ¥çœ‹ä¸‹æ‰“å°å¾—ç»“æœ`["1", "2", "4294967294", "a", "c", "b", "-1", "4294967295"]`ï¼Œå¯èƒ½ä¼šæœ‰ç–‘é—®ä¸ºä»€ä¹ˆæ²¡æœ‰`Symbol`ï¼Œå› ä¸º`Object.keys()`è¿”å›çš„æ˜¯å¯æšä¸¾çš„é”®å±æ€§(ä¸åŒ…å« Symbol å±æ€§çš„é”®å)ã€‚

## æ€è€ƒ

è¯¦ç»†é˜…è¯»äº†å…¶è§„èŒƒï¼Œå‘ç°æˆ‘ä»¬éœ€è¦æ¢ä¸ªè§’åº¦æ¥ç†è§£ js è¿™é—¨è¯­è¨€ï¼Œæ–‡æ¡£é‡Œé¢æœ‰å¾ˆå¤šå†…ç½®æ–¹æ³•ï¼Œè™½ç„¶ä¸å¤ªå¥½ç†è§£ï¼Œä½†å¤§å¤šæ•°å¯ä»¥æ ¹æ®å­—é¢çš„æ„æ€æ¥ç†è§£è¿™ä¸ªæ–¹æ³•æ˜¯ä½œç”¨äºä»€ä¹ˆçš„ï¼Œå€’ä¹Ÿç®—æ˜¯æ¢äº†ä¸€ç§æ€è€ƒé—®é¢˜çš„æ–¹å¼ã€‚ä¸è¿‡ä»é˜…è¯»è§„èŒƒæ¥çœ‹ï¼Œä½¿å¾—æˆ‘ä»¬å¯ä»¥å¾€ä¸‹é’»ç ”å…¶å†…éƒ¨åŸç†æˆ–é€»è¾‘ï¼Œå¯ä»¥æ›´æ·±å…¥çš„æŒ–æ˜ä»–ä¸ºä»€ä¹ˆè¦è¿™æ ·åšï¼Œè¿™æ ·çš„å¥½å¤„æœ‰å“ªäº›ã€‚

## References

https://zhuanlan.zhihu.com/p/389201653

<Gitalk />
